---
- name: Docker æœåŠ¡å™¨ç®¡ç† (ä¿®å¤ç‰ˆ)
  hosts: docker_servers
  become: yes
  gather_facts: yes
  
  tasks:
    - name: æ˜¾ç¤ºä¸»æœºä¿¡æ¯
      debug:
        msg: |
          ğŸ–¥ï¸ ä¸»æœº: {{ inventory_hostname }}
          ğŸ“ IP: {{ ansible_host }}
          ğŸ§ ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
    - name: æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€
      systemd:
        name: docker
        state: started
        enabled: yes
      register: docker_status

    - name: æ˜¾ç¤º Docker æœåŠ¡ä¿¡æ¯
      debug:
        msg: |
          ğŸ³ Docker æœåŠ¡çŠ¶æ€: {{ docker_status.status.ActiveState }}
          ğŸ”„ å¼€æœºå¯åŠ¨: {{ docker_status.status.UnitFileState }}
          âš¡ æœåŠ¡å˜æ›´: {{ docker_status.changed }}

    # ä¿®å¤æ¨¡æ¿è¯­æ³•å†²çª
    - name: è·å– Docker ç‰ˆæœ¬ä¿¡æ¯
      shell: 'docker info --format "{%raw%}{{.ServerVersion}}{%endraw%}"'
      register: docker_version
      ignore_errors: yes

    - name: è·å– Docker è¯¦ç»†ä¿¡æ¯
      shell: |
        echo "=== Docker åŸºæœ¬ä¿¡æ¯ ==="
        docker --version
        echo "=== è¿è¡Œä¸­çš„å®¹å™¨ ==="
        docker ps --format "table {%raw%}{{.Names}}\t{{.Status}}\t{{.Ports}}{%endraw%}" || echo "æ— è¿è¡Œä¸­çš„å®¹å™¨"
        echo "=== é•œåƒç»Ÿè®¡ ==="
        docker images --format "table {%raw%}{{.Repository}}\t{{.Tag}}\t{{.Size}}{%endraw%}" | head -10
        echo "=== ç£ç›˜ä½¿ç”¨ ==="
        docker system df
      register: docker_info
      ignore_errors: yes

    - name: æ˜¾ç¤º Docker è¯¦ç»†ä¿¡æ¯
      debug:
        msg: |
          ğŸ“¦ Docker ç‰ˆæœ¬: {{ docker_version.stdout | default('è·å–å¤±è´¥') }}
          
          ğŸ“Š è¯¦ç»†ä¿¡æ¯:
          {{ docker_info.stdout | default('è·å–å¤±è´¥') }}

    - name: æ£€æŸ¥ Docker Compose
      shell: docker-compose --version 2>/dev/null || docker compose version 2>/dev/null || echo "æœªå®‰è£…"
      register: compose_version
      ignore_errors: yes

    - name: æ˜¾ç¤º Compose ä¿¡æ¯
      debug:
        msg: "ğŸ”§ Docker Compose: {{ compose_version.stdout }}"

    # ç³»ç»Ÿç‰¹å®šçš„ Docker é…ç½®æ£€æŸ¥
    - name: æ£€æŸ¥ Docker é…ç½® (Debian/Ubuntu)
      block:
        - name: æ£€æŸ¥ Docker ä»“åº“é…ç½®
          shell: apt-cache policy docker.io docker-ce 2>/dev/null || echo "æ—  Docker ä»“åº“é…ç½®"
          register: docker_repo_debian
          
        - name: æ˜¾ç¤ºä»“åº“ä¿¡æ¯
          debug:
            msg: |
              ğŸ“¦ Debian/Ubuntu Docker ä»“åº“:
              {{ docker_repo_debian.stdout }}
      when: ansible_os_family == "Debian"

    - name: æ£€æŸ¥ Docker é…ç½® (RedHat/Fedora)
      block:
        - name: æ£€æŸ¥ Docker ä»“åº“é…ç½®
          shell: dnf repolist | grep -i docker || echo "æ—  Docker ä»“åº“é…ç½®"
          register: docker_repo_fedora
          
        - name: æ˜¾ç¤ºä»“åº“ä¿¡æ¯
          debug:
            msg: |
              ğŸ“¦ RedHat/Fedora Docker ä»“åº“:
              {{ docker_repo_fedora.stdout }}
      when: ansible_os_family == "RedHat"

    - name: æ£€æŸ¥ Docker ç½‘ç»œ
      shell: docker network ls
      register: docker_networks
      ignore_errors: yes

    - name: æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
      debug:
        msg: |
          ğŸŒ Docker ç½‘ç»œ:
          {{ docker_networks.stdout | default('è·å–å¤±è´¥') }}

    # ä¿®å¤å­˜å‚¨é©±åŠ¨è·å–
    - name: æ£€æŸ¥ Docker å­˜å‚¨é©±åŠ¨
      shell: 'docker info --format "{%raw%}{{.Driver}}{%endraw%}"'
      register: docker_driver
      ignore_errors: yes

    - name: è·å– Docker æ ¹ç›®å½•
      shell: 'docker info --format "{%raw%}{{.DockerRootDir}}{%endraw%}"'
      register: docker_root_dir
      ignore_errors: yes

    - name: æ˜¾ç¤ºå­˜å‚¨ä¿¡æ¯
      debug:
        msg: |
          ğŸ’¾ å­˜å‚¨é©±åŠ¨: {{ docker_driver.stdout | default('æœªçŸ¥') }}
          ğŸ“ Docker æ ¹ç›®å½•: {{ docker_root_dir.stdout | default('/var/lib/docker') }}

    # æ–°å¢ï¼šå®¹å™¨ç»Ÿè®¡ä¿¡æ¯
    - name: è·å–å®¹å™¨ç»Ÿè®¡
      shell: |
        echo "=== å®¹å™¨ç»Ÿè®¡ ==="
        echo "è¿è¡Œä¸­: $(docker ps -q | wc -l)"
        echo "æ€»å®¹å™¨: $(docker ps -aq | wc -l)"
        echo "é•œåƒæ•°é‡: $(docker images -q | wc -l)"
        echo "ç½‘ç»œæ•°é‡: $(docker network ls -q | wc -l)"
        echo "æ•°æ®å·: $(docker volume ls -q | wc -l)"
      register: docker_stats
      ignore_errors: yes

    - name: æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
      debug:
        msg: |
          ğŸ“ˆ Docker ç»Ÿè®¡:
          {{ docker_stats.stdout | default('è·å–å¤±è´¥') }}

    # æ–°å¢ï¼šç³»ç»Ÿèµ„æºä½¿ç”¨
    - name: æ£€æŸ¥ç³»ç»Ÿèµ„æº
      shell: |
        echo "=== ç³»ç»Ÿèµ„æº ==="
        echo "CPU: $(nproc) æ ¸å¿ƒ"
        echo "å†…å­˜: $(free -h | grep '^Mem:' | awk '{print $2}') æ€»è®¡, $(free -h | grep '^Mem:' | awk '{print $3}') å·²ç”¨"
        echo "ç£ç›˜: $(df -h / | tail -1 | awk '{print $2}') æ€»è®¡, $(df -h / | tail -1 | awk '{print $3}') å·²ç”¨"
      register: system_resources
      ignore_errors: yes

    - name: æ˜¾ç¤ºç³»ç»Ÿèµ„æº
      debug:
        msg: |
          ğŸ–¥ï¸ ç³»ç»Ÿèµ„æº:
          {{ system_resources.stdout | default('è·å–å¤±è´¥') }}
