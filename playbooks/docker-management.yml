---
- name: Docker å®¹å™¨ç®¡ç†
  hosts: all
  become: yes
  vars:
    action: "status"  # status, cleanup, restart, update

  tasks:
    - name: ğŸ³ æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€
      systemd:
        name: docker
      register: docker_service

    - name: ğŸ“Š æ˜¾ç¤º Docker ä¿¡æ¯
      shell: |
        echo "=== Docker ç‰ˆæœ¬ ==="
        docker --version
        echo "=== è¿è¡Œä¸­çš„å®¹å™¨ ==="
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        echo "=== é•œåƒç»Ÿè®¡ ==="
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
        echo "=== ç³»ç»Ÿä½¿ç”¨æƒ…å†µ ==="
        docker system df
      register: docker_info

    - name: ğŸ–¥ï¸  æ˜¾ç¤º Docker çŠ¶æ€
      debug:
        msg: "{{ docker_info.stdout_lines }}"

    - name: ğŸ§¹ æ¸…ç† Docker (å½“ action=cleanup)
      shell: |
        echo "æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨..."
        docker container prune -f
        echo "æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
        docker image prune -f
        echo "æ¸…ç†æœªä½¿ç”¨çš„ç½‘ç»œ..."
        docker network prune -f
        echo "æ¸…ç†æœªä½¿ç”¨çš„å·..."
        docker volume prune -f
      when: action == "cleanup"
      register: cleanup_result

    - name: ğŸ“‹ æ˜¾ç¤ºæ¸…ç†ç»“æœ
      debug:
        msg: "{{ cleanup_result.stdout_lines }}"
      when: action == "cleanup"

    - name: ğŸ”„ é‡å¯ Docker æœåŠ¡ (å½“ action=restart)
      systemd:
        name: docker
        state: restarted
      when: action == "restart"

    - name: âœ… æ“ä½œå®Œæˆ
      debug:
        msg: |
          ğŸ‰ Docker {{ action }} æ“ä½œå®Œæˆï¼
          ğŸ“… æ“ä½œæ—¶é—´: {{ ansible_date_time.iso8601 }}
          ğŸ–¥ï¸  ä¸»æœº: {{ inventory_hostname }}
