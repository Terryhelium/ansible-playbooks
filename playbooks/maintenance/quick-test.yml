# ğŸš€ å¢å¼ºç‰ˆå¿«é€Ÿæµ‹è¯• - å¸¦è¯¦ç»†æŠ¥å‘Š
- name: "âš¡ å¢å¼ºç‰ˆå¿«é€Ÿç³»ç»Ÿæµ‹è¯•"
  hosts: all
  gather_facts: yes
  become: no
  
  vars:
    test_results: []
    report_file: "/tmp/semaphore-test-report.json"
    
  tasks:
    - name: "ğŸ¯ æµ‹è¯•å¼€å§‹"
      debug:
        msg: |
          ğŸš€ å¼€å§‹æ‰§è¡Œå¢å¼ºç‰ˆå¿«é€Ÿç³»ç»Ÿæµ‹è¯•
          æ—¶é—´: {{ ansible_date_time.iso8601 }}
          æ‰§è¡Œä¸»æœº: {{ inventory_hostname }}
          æ“ä½œç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}

    - name: "ğŸ“Š æ”¶é›†ç³»ç»ŸåŸºç¡€ä¿¡æ¯"
      set_fact:
        system_info:
          hostname: "{{ inventory_hostname }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          kernel: "{{ ansible_kernel }}"
          architecture: "{{ ansible_architecture }}"
          cpu_cores: "{{ ansible_processor_vcpus }}"
          memory_mb: "{{ ansible_memtotal_mb }}"
          uptime: "{{ ansible_uptime_seconds }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"

    - name: "ğŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´"
      shell: |
        df -h / | tail -1 | awk '{print $4 " å¯ç”¨ / " $2 " æ€»è®¡ (" $5 " å·²ä½¿ç”¨)"}'
      register: disk_info
      changed_when: false

    - name: "ğŸŒ¡ï¸ æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½"
      shell: |
        uptime | awk -F'load average:' '{print $2}' | sed 's/^ *//'
      register: load_info
      changed_when: false

    - name: "ğŸ”— ç½‘ç»œè¿é€šæ€§æµ‹è¯•"
      ping:
        data: "Semaphore ç½‘ç»œæµ‹è¯•"
      register: ping_result

    - name: "ğŸ“ æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•"
      block:
        - name: "åˆ›å»ºæµ‹è¯•ç›®å½•"
          file:
            path: "/tmp/semaphore-test"
            state: directory
            mode: '0755'
          register: dir_result

        - name: "åˆ›å»ºæµ‹è¯•æ–‡ä»¶"
          copy:
            content: |
              Semaphore æµ‹è¯•æ–‡ä»¶
              åˆ›å»ºæ—¶é—´: {{ ansible_date_time.iso8601 }}
              ä¸»æœº: {{ inventory_hostname }}
              æµ‹è¯•ID: {{ 999999 | random }}
            dest: "/tmp/semaphore-test/test-{{ ansible_date_time.epoch }}.txt"
            mode: '0644'
          register: file_result

        - name: "éªŒè¯æ–‡ä»¶åˆ›å»º"
          stat:
            path: "{{ file_result.dest }}"
          register: file_stat

    - name: "ğŸ§® æ±‡æ€»æµ‹è¯•ç»“æœ"
      set_fact:
        test_summary:
          test_name: "å¢å¼ºç‰ˆå¿«é€Ÿç³»ç»Ÿæµ‹è¯•"
          execution_time: "{{ ansible_date_time.iso8601 }}"
          host_info: "{{ system_info }}"
          disk_space: "{{ disk_info.stdout }}"
          system_load: "{{ load_info.stdout }}"
          network_test: "{{ 'PASS' if ping_result is succeeded else 'FAIL' }}"
          file_system_test: "{{ 'PASS' if file_stat.stat.exists else 'FAIL' }}"
          test_file_path: "{{ file_result.dest | default('N/A') }}"
          overall_status: "{{ 'SUCCESS' if (ping_result is succeeded and file_stat.stat.exists) else 'FAILED' }}"

    - name: "ğŸ’¾ ä¿å­˜æµ‹è¯•æŠ¥å‘Š"
      copy:
        content: "{{ test_summary | to_nice_json }}"
        dest: "{{ report_file }}"
        mode: '0644'
      register: report_saved

    - name: "ğŸ“‹ æ˜¾ç¤ºè¯¦ç»†æµ‹è¯•æŠ¥å‘Š"
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    ğŸš€ SEMAPHORE æµ‹è¯•æŠ¥å‘Š                      â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ ğŸ“… æ‰§è¡Œæ—¶é—´: {{ test_summary.execution_time }}
          â•‘ ğŸ–¥ï¸  ä¸»æœºåç§°: {{ test_summary.host_info.hostname }}
          â•‘ ğŸ§ æ“ä½œç³»ç»Ÿ: {{ test_summary.host_info.os }}
          â•‘ ğŸ’» CPUæ ¸å¿ƒ: {{ test_summary.host_info.cpu_cores }} æ ¸
          â•‘ ğŸ’¾ å†…å­˜å¤§å°: {{ test_summary.host_info.memory_mb }} MB
          â•‘ ğŸ’¿ ç£ç›˜ç©ºé—´: {{ test_summary.disk_space }}
          â•‘ ğŸ“Š ç³»ç»Ÿè´Ÿè½½: {{ test_summary.system_load }}
          â•‘ ğŸŒ ç½‘ç»œæµ‹è¯•: {{ test_summary.network_test }}
          â•‘ ğŸ“ æ–‡ä»¶æµ‹è¯•: {{ test_summary.file_system_test }}
          â•‘ ğŸ“„ æµ‹è¯•æ–‡ä»¶: {{ test_summary.test_file_path }}
          â•‘ ğŸ“Š æ•´ä½“çŠ¶æ€: {{ test_summary.overall_status }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜è‡³: {{ report_file }}
          
          ğŸ” æŸ¥çœ‹æŠ¥å‘Šå‘½ä»¤:
          cat {{ report_file }} | jq '.'

    - name: "ğŸ‰ æµ‹è¯•å®Œæˆé€šçŸ¥"
      debug:
        msg: |
          âœ… å¢å¼ºç‰ˆå¿«é€Ÿæµ‹è¯•æ‰§è¡Œå®Œæˆï¼
          
          ğŸ“Š æµ‹è¯•ç»“æœæ‘˜è¦:
          â€¢ ä¸»æœº: {{ test_summary.host_info.hostname }}
          â€¢ çŠ¶æ€: {{ test_summary.overall_status }}
          â€¢ ç½‘ç»œ: {{ test_summary.network_test }}
          â€¢ æ–‡ä»¶ç³»ç»Ÿ: {{ test_summary.file_system_test }}
          
          ğŸ“ æŠ¥å‘Šæ–‡ä»¶: {{ report_file }}
          ğŸ“ æµ‹è¯•æ–‡ä»¶: {{ test_summary.test_file_path }}
          
          ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ:
          1. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: cat {{ report_file }}
          2. æ¸…ç†æµ‹è¯•æ–‡ä»¶: rm -rf /tmp/semaphore-test
          3. è¿è¡Œå…¶ä»–æµ‹è¯•: é€‰æ‹©ä¸åŒçš„ Playbook

      when: test_summary.overall_status == "SUCCESS"

    - name: "âŒ æµ‹è¯•å¤±è´¥é€šçŸ¥"
      debug:
        msg: |
          âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼
          
          è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®:
          â€¢ ç½‘ç»œè¿é€šæ€§: {{ test_summary.network_test }}
          â€¢ æ–‡ä»¶ç³»ç»Ÿæƒé™: {{ test_summary.file_system_test }}
          
          ğŸ“„ è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹: {{ report_file }}
      when: test_summary.overall_status == "FAILED"
