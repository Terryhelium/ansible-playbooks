---
- name: ç³»ç»Ÿç»´æŠ¤ Playbook
  hosts: all
  become: yes
  vars:
    maintenance_tasks:
      - name: "ç³»ç»Ÿæ›´æ–°"
        enabled: true
      - name: "æ¸…ç†æ—¥å¿—"
        enabled: true
      - name: "ç£ç›˜æ¸…ç†"
        enabled: true

  tasks:
    - name: ğŸ” æ”¶é›†ç³»ç»Ÿä¿¡æ¯
      setup:
      tags: info

    - name: ğŸ“Š æ˜¾ç¤ºç³»ç»ŸåŸºæœ¬ä¿¡æ¯
      debug:
        msg: |
          ğŸ–¥ï¸  ä¸»æœº: {{ inventory_hostname }}
          ğŸ·ï¸  ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ’¾ å†…å­˜: {{ (ansible_memtotal_mb/1024)|round(1) }}GB
          ğŸ’½ ç£ç›˜: {{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first | filesizeformat }}
          â° è¿è¡Œæ—¶é—´: {{ ansible_uptime_seconds | int | duration }}
      tags: info

    - name: ğŸ”„ æ›´æ–°åŒ…ç¼“å­˜ (Debian/Ubuntu)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: 
        - ansible_os_family == "Debian"
        - maintenance_tasks[0].enabled
      tags: update

    - name: ğŸ”„ æ›´æ–°åŒ…ç¼“å­˜ (RedHat/CentOS/Fedora)
      dnf:
        update_cache: yes
      when: 
        - ansible_os_family == "RedHat"
        - maintenance_tasks[0].enabled
      tags: update

    - name: ğŸ§¹ æ¸…ç†ç³»ç»Ÿæ—¥å¿—
      shell: |
        journalctl --vacuum-time=7d
        find /var/log -name "*.log" -mtime +7 -delete 2>/dev/null || true
      when: maintenance_tasks[1].enabled
      tags: cleanup

    - name: ğŸ’½ æ¸…ç†åŒ…ç¼“å­˜ (Debian/Ubuntu)
      apt:
        autoclean: yes
        autoremove: yes
      when: 
        - ansible_os_family == "Debian"
        - maintenance_tasks[2].enabled
      tags: cleanup

    - name: ğŸ’½ æ¸…ç†åŒ…ç¼“å­˜ (RedHat/CentOS/Fedora)
      dnf:
        autoremove: yes
      when: 
        - ansible_os_family == "RedHat"
        - maintenance_tasks[2].enabled
      tags: cleanup

    - name: ğŸ“ˆ æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage
      tags: check

    - name: âš ï¸  ç£ç›˜ä½¿ç”¨è­¦å‘Š
      debug:
        msg: "âš ï¸  è­¦å‘Š: æ ¹åˆ†åŒºä½¿ç”¨ç‡ {{ disk_usage.stdout }}%ï¼Œå»ºè®®æ¸…ç†ï¼"
      when: disk_usage.stdout|int > 80
      tags: check

    - name: âœ… ç»´æŠ¤å®Œæˆ
      debug:
        msg: |
          ğŸ‰ ç³»ç»Ÿç»´æŠ¤å®Œæˆï¼
          ğŸ“… ç»´æŠ¤æ—¶é—´: {{ ansible_date_time.iso8601 }}
          ğŸ–¥ï¸  ä¸»æœº: {{ inventory_hostname }}
          ğŸ’¾ å½“å‰ç£ç›˜ä½¿ç”¨: {{ disk_usage.stdout }}%
      tags: always
