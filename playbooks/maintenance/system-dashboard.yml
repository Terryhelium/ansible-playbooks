---
# ğŸ“Š ç³»ç»Ÿä¿¡æ¯ä»ªè¡¨æ¿
- name: "ğŸ“Š ç³»ç»Ÿä¿¡æ¯ä»ªè¡¨æ¿"
  hosts: all
  gather_facts: yes
  become: no
  
  tasks:
    - name: "ğŸ–¥ï¸ æ”¶é›†è¯¦ç»†ç³»ç»Ÿä¿¡æ¯"
      shell: |
        echo "=== ç³»ç»Ÿæ¦‚è§ˆ ==="
        hostnamectl 2>/dev/null || echo "ä¸»æœºå: $(hostname)"
        echo ""
        echo "=== CPU ä¿¡æ¯ ==="
        lscpu | grep -E "(Architecture|CPU op-mode|CPU\(s\)|Model name|CPU MHz)" 2>/dev/null || echo "CPU: {{ ansible_processor_vcpus }} æ ¸"
        echo ""
        echo "=== å†…å­˜ä¿¡æ¯ ==="
        free -h 2>/dev/null || echo "å†…å­˜: {{ ansible_memtotal_mb }} MB"
        echo ""
        echo "=== ç£ç›˜ä¿¡æ¯ ==="
        df -h | head -10
        echo ""
        echo "=== ç½‘ç»œä¿¡æ¯ ==="
        ip addr show 2>/dev/null | grep -E "(inet |UP)" || ifconfig 2>/dev/null | grep -E "(inet |UP)"
        echo ""
        echo "=== è¿›ç¨‹ä¿¡æ¯ ==="
        ps aux --sort=-%cpu | head -10
        echo ""
        echo "=== ç³»ç»Ÿè´Ÿè½½ ==="
        uptime
      register: system_dashboard
      changed_when: false

    - name: "ğŸ“‹ æ˜¾ç¤ºç³»ç»Ÿä»ªè¡¨æ¿"
      debug:
        msg: "{{ system_dashboard.stdout_lines }}"

    - name: "ğŸ’¾ ä¿å­˜ä»ªè¡¨æ¿æŠ¥å‘Š"
      copy:
        content: |
          # ğŸ“Š ç³»ç»Ÿä¿¡æ¯ä»ªè¡¨æ¿æŠ¥å‘Š
          
          **ç”Ÿæˆæ—¶é—´**: {{ ansible_date_time.iso8601 }}
          **ä¸»æœºåç§°**: {{ inventory_hostname }}
          **æ“ä½œç³»ç»Ÿ**: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          ## è¯¦ç»†ä¿¡æ¯
          
          ```
          {{ system_dashboard.stdout }}
          ```
          
          ---
          *æŠ¥å‘Šç”± Semaphore è‡ªåŠ¨ç”Ÿæˆ*
        dest: "/tmp/system-dashboard-{{ ansible_date_time.epoch }}.md"
        mode: '0644'
      register: dashboard_file

    - name: "âœ… ä»ªè¡¨æ¿å®Œæˆ"
      debug:
        msg: |
          ğŸ“Š ç³»ç»Ÿä»ªè¡¨æ¿ç”Ÿæˆå®Œæˆï¼
          
          ğŸ“„ æŠ¥å‘Šæ–‡ä»¶: {{ dashboard_file.dest }}
          ğŸ” æŸ¥çœ‹å‘½ä»¤: cat {{ dashboard_file.dest }}
          
          ğŸ“ˆ ä¸»è¦æŒ‡æ ‡:
          â€¢ ä¸»æœº: {{ inventory_hostname }}
          â€¢ ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          â€¢ CPU: {{ ansible_processor_vcpus }} æ ¸
          â€¢ å†…å­˜: {{ ansible_memtotal_mb }} MB
          â€¢ æ¶æ„: {{ ansible_architecture }}
