---
- name: 终极可靠系统检测
  hosts: all
  gather_facts: true

  tasks:
    - name: 收集服务状态信息
      ansible.builtin.service_facts:

    - name: 服务存在性检测，判断防火墙类型
      set_fact:
        firewall_type: >-
          {% if 'firewalld.service' in services %}
            firewalld
          {% elif 'ufw.service' in services %}
            ufw
          {% else %}
            unknown
          {% endif %}

    - name: 获取firewalld状态
      command: firewall-cmd --state
      register: fw_state
      changed_when: false
      failed_when: false
      when: firewall_type == 'firewalld'

    - name: 获取ufw状态
      shell: |
        ufw status | grep -q "Status: active"
      register: ufw_state
      changed_when: false
      failed_when: false
      when: firewall_type == 'ufw'

    - name: 计算防火墙状态
      set_fact:
        firewall_status: >-
          {% if firewall_type == 'firewalld' %}
            {{ fw_state.stdout if fw_state.stdout is defined else '状态未知' }}
          {% elif firewall_type == 'ufw' %}
            {{ 'active' if ufw_state.rc == 0 else 'inactive' }}
          {% else %}
            未检测到标准防火墙
          {% endif %}

    - name: CPU负载检测
      shell: cat /proc/loadavg | awk '{print $1,$2,$3}'
      register: cpu_load
      changed_when: false
      failed_when: false

    - name: 内存使用率检测
      shell: |
        free -m | awk '/Mem/ {printf "%.1f%%", $3/$2*100}'
      register: mem_usage
      changed_when: false
      failed_when: false

    - name: 根分区磁盘使用率检测
      shell: |
        df -h / | awk 'NR==2{print $5}'
      register: disk_usage
      changed_when: false
      failed_when: false

    - name: 输出检测结果
      debug:
        msg: |
          =============== 资源状态 ===============
          防火墙状态: {{ firewall_status }}
          CPU负载: {{ cpu_load.stdout | default('未知') }}
          内存使用: {{ mem_usage.stdout | default('未知') }}
          根分区使用: {{ disk_usage.stdout | default('未知') }}
          =======================================
