---
- name: ç»ˆæå¯é ç³»ç»Ÿæ£€æµ‹
  hosts: all
  gather_facts: true
  vars:
    safe_mode: true  # å®‰å…¨æ¨¡å¼ï¼Œé¿å…æ‰§è¡Œå¯èƒ½å¤±è´¥çš„å‘½ä»¤

  tasks:
    - name: ç³»ç»ŸåŸºç¡€ä¿¡æ¯
      debug:
        msg: |
          â–ˆâ–ˆ ä¸»æœº: {{ ansible_hostname }} ({{ ansible_default_ipv4.address }})
          â–ˆâ–ˆ ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          â–ˆâ–ˆ å†…æ ¸: {{ ansible_kernel }}
          â–ˆâ–ˆ è¿è¡Œ: {{ (ansible_uptime_seconds / 86400) | round(2) }}å¤©

    - name: é˜²ç«å¢™çŠ¶æ€æ£€æµ‹ï¼ˆé›¶å¤±è´¥è®¾è®¡ï¼‰
      block:
        - name: æœåŠ¡å­˜åœ¨æ€§æ£€æµ‹
          set_fact:
            firewall_type: >-
              {% if 'firewalld' in ansible_facts.services %}firewalld
              {% elif 'ufw' in ansible_facts.services %}ufw
              {% else %}unknown{% endif %}

        - name: å®‰å…¨çŠ¶æ€è·å–
          block:
            - name: è·å–firewalldçŠ¶æ€
              command: firewall-cmd --state
              register: fw_state
              changed_when: false
              when: firewall_type == 'firewalld' and not safe_mode

            - name: è·å–ufwçŠ¶æ€
              shell: >
                ufw status 2>/dev/null | grep -q "Status: active"
              register: ufw_state
              changed_when: false
              ignore_errors: true
              when: firewall_type == 'ufw' and not safe_mode

          rescue:
            - debug:
                msg: "å®‰å…¨æ¨¡å¼å·²è·³è¿‡ç›´æ¥æ£€æµ‹"

        - name: æœ€ç»ˆçŠ¶æ€åˆæˆ
          set_fact:
            firewall_status: >-
              {% if firewall_type == 'firewalld' %}
                {{ fw_state.stdout if fw_state is defined else 'çŠ¶æ€æœªçŸ¥(å®‰å…¨æ¨¡å¼)' }}
              {% elif firewall_type == 'ufw' %}
                {{ 'active' if ufw_state is defined and ufw_state.rc == 0 else 'inactive' }}
              {% else %}
                æœªæ£€æµ‹åˆ°æ ‡å‡†é˜²ç«å¢™
              {% endif %}

      rescue:
        - set_fact:
            firewall_status: "æ£€æµ‹å¤±è´¥-å¯ç”¨åº”æ€¥æ–¹æ¡ˆ"
      always:
        - debug:
            msg: "é˜²ç«å¢™çŠ¶æ€: {{ firewall_status }}"

    - name: ç³»ç»Ÿèµ„æºå¥åº·åº¦
      block:
        - name: CPUè´Ÿè½½æ£€æµ‹
          shell: cat /proc/loadavg | awk '{print $1,$2,$3}'
          register: cpu_load
          changed_when: false
          ignore_errors: "{{ safe_mode }}"

        - name: å†…å­˜ä½¿ç”¨ç‡
          shell: free -m | awk '/Mem/{printf \"%.1f%%\", $3/$2*100}'
          register: mem_usage
          changed_when: false
          ignore_errors: "{{ safe_mode }}"

        - name: ç£ç›˜ç©ºé—´
          shell: df -h / | awk 'NR==2{print $5}'
          register: disk_usage
          changed_when: false
          ignore_errors: "{{ safe_mode }}"

      always:
        - debug:
            msg: |
              =============== èµ„æºçŠ¶æ€ ===============
              CPUè´Ÿè½½: {{ cpu_load.stdout | default('å®‰å…¨æ¨¡å¼è·³è¿‡') }}
              å†…å­˜ä½¿ç”¨: {{ mem_usage.stdout | default('å®‰å…¨æ¨¡å¼è·³è¿‡') }}
              æ ¹åˆ†åŒº: {{ disk_usage.stdout | default('å®‰å…¨æ¨¡å¼è·³è¿‡') }}
              =======================================

    - name: ç»ˆæå¥åº·æŠ¥å‘Š
      debug:
        msg: |
          ğŸ”’ å®‰å…¨æ£€æµ‹æŠ¥å‘Š ({{ ansible_date_time.iso8601 }})
          --------------------------------------------
          ä¸»æœº: {{ ansible_hostname }} ({{ ansible_system_vendor }})
          ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          --------------------------------------------
          é˜²ç«å¢™: {{ firewall_status }}
          SELinux: {{ ansible_selinux.status | default('æœªå¯ç”¨') }}
          --------------------------------------------
          æ ¸å¿ƒèµ„æº:
            CPU: {{ ansible_processor_vcpus }}æ ¸ {{ cpu_load.stdout | default('N/A') }}
            å†…å­˜: {{ (ansible_memtotal_mb / 1024) | round(1) | default('?') }}GB 
            å­˜å‚¨: {{ ansible_mounts[0].size_total | default('æœªçŸ¥') }}
          --------------------------------------------
          ğŸ“Œ æ£€æµ‹æ¨¡å¼: {{ 'å®‰å…¨æ¨¡å¼' if safe_mode else 'å®Œæ•´æ¨¡å¼' }}
